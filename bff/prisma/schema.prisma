generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  tenantId      String         @default("default")
  username      String
  password      String
  name          String
  role          String         @default("TEACHER") // ADMIN, TEACHER, VIEWER
  status        String         @default("ACTIVE") // ACTIVE, DISABLED, LOCKED, PENDING
  loginFailures Int            @default(0)
  lockedUntil   DateTime?
  metadata      String?
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  announcements Announcement[]
  assets        Asset[]
  ownedTools    Tool[]         @relation("ToolOwner")
  teacherProfile TeacherProfile?

  @@unique([tenantId, username])
  @@index([tenantId, role])
  @@index([tenantId, status])
}

model TeacherProfile {
  id        String @id @default(uuid())
  userId    String @unique
  isHomeroom Boolean @default(false)
  homeroomClass String? // e.g. "1" (Class 1)
  teachingAssignments String? // JSON: [{"class": "1", "subject": "数学"}, {"class": "2", "subject": "数学"}]
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  tag       String?
  tagType   String   @default("info")
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])
}

model Tool {
  id          String    @id @default(uuid())
  tenantId    String    @default("default")
  code        String
  name        String
  description String?
  icon        String
  route       String
  category    String
  tags        String?
  status      String    @default("ACTIVE")
  isEnabled   Boolean   @default(true)
  order       Int       @default(0)
  deletedAt   DateTime?
  ownerId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  assets      Asset[]
  owner       User?     @relation("ToolOwner", fields: [ownerId], references: [id])

  @@unique([tenantId, code])
  @@unique([tenantId, route])
  @@index([tenantId, category])
  @@index([tenantId, status])
}

model Asset {
  id         String    @id @default(uuid())
  tenantId   String    @default("default")
  title      String
  summary    String?
  content    String?
  contentUrl String?
  metadata   String?
  type       String
  tags       String?
  version    Int       @default(1)
  authorId   String
  toolId     String?
  visibility String    @default("PRIVATE")
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  tool       Tool?     @relation(fields: [toolId], references: [id])
  author     User      @relation(fields: [authorId], references: [id])

  @@index([tenantId, type])
  @@index([tenantId, visibility])
  @@index([tenantId, authorId])
  @@index([tenantId, toolId])
}

model Student {
  id          String       @id @default(uuid())
  tenantId    String       @default("default")
  name        String
  studentId   String
  class       String
  scores      Score[]
  submissions Submission[]

  @@unique([tenantId, studentId])
  @@index([tenantId, class])
}

model Exam {
  id       String   @id @default(uuid())
  tenantId String   @default("default")
  name     String
  date     DateTime
  type     String
  scores   Score[]

  @@unique([tenantId, name])
  @@index([tenantId, date])
}

model Score {
  id        String   @id @default(uuid())
  tenantId  String   @default("default")
  value     Float
  subject   String
  studentId String
  examId    String
  updatedBy String?
  details   String?  // JSON for extra metadata (rank, totalCount, rank3, rank6)
  sourceEventId String?
  updatedAt DateTime @updatedAt
  exam      Exam     @relation(fields: [examId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id])
  sourceEvent LearningEvent? @relation("ScoreSourceEvent", fields: [sourceEventId], references: [id])

  @@unique([tenantId, examId, studentId, subject])
  @@index([tenantId, examId])
  @@index([tenantId, studentId])
  @@index([tenantId, subject])
  @@index([tenantId, sourceEventId])
}

model Assignment {
  id          String       @id @default(uuid())
  tenantId    String       @default("default")
  name        String
  subject     String
  description String?
  totalPoints Float        @default(0)
  status      String       @default("DRAFT")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  answerKeys  AnswerKey[]
  submissions Submission[]

  @@index([tenantId, subject])
  @@index([tenantId, status])
}

model AnswerKey {
  id           String     @id @default(uuid())
  tenantId     String     @default("default")
  assignmentId String
  questionId   String
  questionType String
  content      String
  points       Float      @default(0)
  createdAt    DateTime   @default(now())
  assignment   Assignment @relation(fields: [assignmentId], references: [id])

  @@unique([tenantId, assignmentId, questionId])
}

model Submission {
  id           String         @id @default(uuid())
  tenantId     String         @default("default")
  assignmentId String
  studentId    String
  status       String         @default("PENDING")
  totalScore   Float          @default(0)
  payloadUrl   String?
  sourceEventId String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  grading      GradingResult?
  student      Student        @relation(fields: [studentId], references: [id])
  assignment   Assignment     @relation(fields: [assignmentId], references: [id])
  sourceEvent  LearningEvent? @relation("SubmissionSourceEvent", fields: [sourceEventId], references: [id])

  @@index([tenantId, assignmentId])
  @@index([tenantId, studentId])
  @@index([tenantId, status])
  @@index([tenantId, sourceEventId])
}

model GradingResult {
  id              String     @id @default(uuid())
  tenantId        String     @default("default")
  submissionId    String     @unique
  objectiveScore  Float      @default(0)
  subjectiveScore Float      @default(0)
  totalScore      Float      @default(0)
  details         String?
  reviewedBy      String?
  updatedAt       DateTime   @updatedAt
  submission      Submission @relation(fields: [submissionId], references: [id])
}

model AuditLog {
  id         String   @id @default(uuid())
  operatorId String
  action     String
  resource   String
  resourceId String?
  details    String
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
}

// --- Learning Data (Event Bus) ---
model LearningEvent {
  id         String   @id @default(uuid())
  tenantId   String   @default("default")
  actorId    String
  actorRole  String?
  appCode    String?
  action     String
  targetType String?
  targetId   String?
  payload    String?
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())
  scores     Score[]      @relation("ScoreSourceEvent")
  submissions Submission[] @relation("SubmissionSourceEvent")

  @@index([tenantId, actorId])
  @@index([tenantId, action])
  @@index([tenantId, appCode])
  @@index([tenantId, occurredAt])
}

model Group {
  id        String   @id @default(uuid())
  name      String
  icon      String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  entries   Entry[]
}

model Entry {
  id          String   @id @default(uuid())
  name        String
  description String
  icon        String
  url         String
  status      String
  featured    Boolean  @default(false)
  order       Int
  usage       Int      @default(0)
  tags        String?
  groupId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  group       Group    @relation(fields: [groupId], references: [id])
}

// --- Portal UI Settings (Admin configurable copy / tips) ---
model PortalUiConfig {
  id           String   @id @default(uuid())
  tenantId     String   @default("default")
  homeTitle    String   @default("常用应用")
  homeSubtitle String   @default("您收藏的教学工具，触手可及")
  tipsEnabled  Boolean  @default(true)
  tipsTitle    String   @default("AI 提问小技巧")
  tipsContent  String   @default("试着给 AI 一个具体的“身份”，比如“你是一位有20年经验的中学数学老师”，它的回答会更专业哦。")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId])
  @@index([tenantId])
}

model OcrTask {
  id         String   @id @default(uuid())
  userId     String
  fileName   String
  status     String
  source     String
  fullZipUrl String?
  result     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// --- Question Bank ---
model Question {
  id              String   @id @default(uuid())
  tenantId        String   @default("default")
  stem            String
  type            String   // single, multi, fill, short, essay
  options         String?  // JSON
  answer          String?  // JSON
  analysis        String?  // Markdown/Text
  subject         String?
  grade           String?
  difficulty      Int      @default(3)
  knowledgePoints String?  // JSON array
  attachments     String?  // JSON array
  sourceAssetId   String?  // Asset.id (weak link)
  status          String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  version         Int      @default(1)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, subject])
  @@index([tenantId, grade])
  @@index([tenantId, status])
  @@index([tenantId, sourceAssetId])
}
